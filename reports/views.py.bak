from django.shortcuts import render
from django.http import HttpResponse
from materials.models import Material
from usage.models import MaterialUsage
from django.db.models import Sum
import csv

# PDF generation
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import letter


# -------------------------------
# REPORTS HOME PAGE
# -------------------------------
def report_home(request):
    return render(request, 'reports/report_list.html')



# -------------------------------
# 1. UNIT WISE REPORT
# -------------------------------
def unit_wise_report(request):
    units = {}
    materials = Material.objects.all()

    for m in materials:
        units[m.unit] = units.get(m.unit, 0) + m.quantity

    return render(request, 'reports/unit_report.html', {'units': units})


# -------------------------------
# 2. STOCK SUMMARY REPORT
# -------------------------------
def stock_summary(request):
    materials = Material.objects.all()
    summary = []

    for material in materials:
        used_qty = MaterialUsage.objects.filter(material=material).aggregate(
            total_used=Sum('quantity_used')
        )['total_used'] or 0

        remaining = material.quantity - used_qty

        summary.append({
            'name': material.name,
            'unit': material.unit,
            'total_added': material.quantity,
            'total_used': used_qty,
            'remaining': remaining,
        })

    return render(request, 'reports/stock_summary.html', {'summary': summary})


# -------------------------------
# 3. LOW STOCK REPORT (NEW)
# -------------------------------
def low_stock_report(request):
    materials = Material.objects.all()
    low_stock = []

    for material in materials:
        used_qty = MaterialUsage.objects.filter(material=material).aggregate(
            total_used=Sum('quantity_used')
        )['total_used'] or 0

        remaining = material.quantity - used_qty

        if remaining <= 5:
            low_stock.append({
                'name': material.name,
                'unit': material.unit,
                'remaining': remaining,
            })

    return render(request, 'reports/low_stock.html', {'low_stock': low_stock})


# -------------------------------
# 4. DOWNLOAD CSV
# -------------------------------
def download_csv(request):
    materials = Material.objects.all()
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = 'attachment; filename="materials_report.csv"'

    writer = csv.writer(response)
    writer.writerow(['Name', 'Description', 'Quantity', 'Unit', 'Created By'])

    for m in materials:
        writer.writerow([
            m.name,
            m.description,
            m.quantity,
            m.unit,
            m.created_by.username if m.created_by else ''
        ])

    return response


# -------------------------------
# 5. DOWNLOAD PDF (NEW)
# -------------------------------
def download_pdf(request):
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = 'attachment; filename="materials_report.pdf"'

    p = canvas.Canvas(response, pagesize=letter)
    width, height = letter

    y = height - 50
    p.setFont("Helvetica-Bold", 16)
    p.drawString(50, y, "Materials Report")

    y -= 40
    p.setFont("Helvetica", 12)

    materials = Material.objects.all()

    for m in materials:
        line = f"{m.name} | Qty: {m.quantity} | Unit: {m.unit}"
        p.drawString(50, y, line)
        y -= 20
        if y < 50:
            p.showPage()
            y = height - 50

    p.save()
    return response
